@model IEnumerable<prjDB_GamingForm_Show.ViewModels.CSignalRUseAdminList>

<p>
    <h2 style="font-size:30px">管理者列表</h2>
</p>

<table class="table table-dark table-hover" style="color:cornsilk;font-size:20px;border-radius:5px">
    <thead>
        <tr>
            <th>
                編號
            </th>
            <th>
                名稱
            </th>
            <th>
                狀態
            </th>
            <th>
                聊天室
            </th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.AdminId)
                </td>
                <td id="name">
                    @Html.DisplayFor(modelItem => item.AdminName)
                </td>
                <td id="@($"onlineStatus_{item.AdminName}")">
                    <!-- 在線狀態將在此處更新 -->離線
                </td>
                <td>
                    <button id="@($"sendMessage_{item.AdminName}")" onclick="openChat(@item.AdminId)" class="btn btn-outline-light">開/關</button>
                </td>
            </tr>
        }
    </tbody>
</table>

 <script>

    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
    var notCheckMessage = 0;    
    // 與Server建立連線
    connection.start().then(function () {
        console.log("Hub 連線完成");
    }).catch(function (err) {
        alert('連線錯誤: ' + err.toString());
    });

    connection.on("ReceiverUpdContent", function () {
        updateNotificationCount();
    })
    function updateNotificationCount() {
        notCheckMessage = $('#notCheckMessageCount').text()
        notCheckMessage++;
        $('#notCheckMessageCount').text(notCheckMessage)
    }
    function isChatOpen(){

    }

    //更新連線 ID 列表事件
    connection.on("UpdList", function (jsonList) {
        var list = JSON.parse(jsonList);
        $("#IDList li").remove();
        for (i = 0; i < list.length; i++) {

            updateUsersList(list);
        }
    });
    async function updateUsersList(users) {
        // 更新用戶列表的顯示
        // $("#test").load('@Url.Content("~/Admin/SignalRPV")');

        // 更新管理者在線狀態
        for (var i = 0; i < users.length; i++) {
            await getAdminOnlineStatus(users[i]);
        }
    }

    async function getAdminOnlineStatus(adminName) {
        // 呼叫 SignalR Hub 方法獲取管理者的在線狀態
        connection.invoke("GetAdminOnlineStatus", adminName).then(function (isOnline) {
            // 觸發更新在線狀態的事件
            connection.invoke("UpdateAdminOnlineStatus", adminName, isOnline);
        });
    }
    connection.on("UpdAdminOnlineStatus", function (adminName, isOnline) {
        // 根據管理者名稱和在線狀態更新前端顯示
        var statusId = `#onlineStatus_${adminName}`;
        $(statusId).html(isOnline ? "在線" : "離線");
    });

    function openChat(id) {
        var div = document.querySelector('#AdminsChat');
        if (div.style.display === "none") {
            $('#AdminsChat').load(`@Url.Content("~/Admin/ChatPV")?id=${id}`);
            div.style.display = "block"; // 顯示
        }
        else {
            div.style.display = "none"; // 隱藏
        }
        $.ajax({
            type: 'post',
            url: '/Admin/CheckAllMessage',
            data: { senderid: id }
        });
    }

</script>

